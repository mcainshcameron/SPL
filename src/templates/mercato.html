{% extends "base.html" %}
{% set active_page = 'mercato' %}

{% block title %}Mercato - SPL{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
{% endblock %}

{% block content %}
<section class="section">
    <h1>Mercato</h1>
    <p class="section-subtitle">Valori di mercato aggiornati settimanalmente</p>
    
    <!-- Sort Controls -->
    <div class="filters">
        <div class="filter-group">
            <label>Ordina per:</label>
            <select id="sortSelect" class="sort-select">
                <option value="value-desc">Valore (Alto → Basso)</option>
                <option value="value-asc">Valore (Basso → Alto)</option>
                <option value="gainer">Maggior Rialzo</option>
                <option value="loser">Maggior Ribasso</option>
            </select>
        </div>
    </div>

    <!-- Market Grid -->
    <div class="market-grid" id="marketGrid">
        {% for player in players %}
        <a href="/players/{{ player.slug }}/" class="market-card" 
           data-value="{{ player.value }}" 
           data-change="{{ player.change }}">
            <div class="market-card-header">
                <h3>{{ player.display_name }}</h3>
                <div class="market-value">{{ player.value|currency }}</div>
            </div>
            <div class="market-change {% if player.change > 0 %}positive{% elif player.change < 0 %}negative{% endif %}">
                {% if player.change > 0 %}
                ↑ {{ player.change|currency }} ({{ player.change_percent|round(1) }}%)
                {% elif player.change < 0 %}
                ↓ {{ player.change|abs|currency }} ({{ player.change_percent|round(1) }}%)
                {% else %}
                — Invariato
                {% endif %}
            </div>
            <canvas class="sparkline" width="200" height="40" 
                    data-history='{{ player.history|map(attribute="Market Value")|list|tojson }}'></canvas>
        </a>
        {% endfor %}
    </div>
</section>

<script src="/static/js/sparkline.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize sparklines
    document.querySelectorAll('.sparkline').forEach(canvas => {
        const history = JSON.parse(canvas.dataset.history);
        drawSparkline(canvas, history);
    });
    
    // Sort functionality
    const sortSelect = document.getElementById('sortSelect');
    const grid = document.getElementById('marketGrid');
    
    sortSelect.addEventListener('change', function() {
        const cards = Array.from(grid.querySelectorAll('.market-card'));
        
        cards.sort((a, b) => {
            const valueA = parseFloat(a.dataset.value);
            const valueB = parseFloat(b.dataset.value);
            const changeA = parseFloat(a.dataset.change);
            const changeB = parseFloat(b.dataset.change);
            
            switch(this.value) {
                case 'value-desc':
                    return valueB - valueA;
                case 'value-asc':
                    return valueA - valueB;
                case 'gainer':
                    return changeB - changeA;
                case 'loser':
                    return changeA - changeB;
                default:
                    return 0;
            }
        });
        
        // Re-append in new order
        cards.forEach(card => grid.appendChild(card));
    });
});
</script>
{% endblock %}
